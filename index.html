<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuron Notes - Облачные заметки</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Стили оставляем те же, что были в оригинале */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #6366f1; --primary-dark: #4f46e5; --bg: #0f0f23; --card-bg: #1a1b2e; --text: #ffffff; --text-secondary: #a0a0c0; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; overflow: hidden; }
        .container { display: flex; height: 100%; max-width: 1400px; margin: 0 auto; }
        .sidebar { width: 300px; background: var(--card-bg); padding: 1rem; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .header { padding: 1rem 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .new-note-btn { background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; }
        .notes-list { flex: 1; overflow-y: auto; padding: 1rem; }
        .note-item { background: var(--card-bg); padding: 1.5rem; margin-bottom: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.1); }
        .note-item:hover { border-color: var(--primary); transform: translateY(-2px); }
        .note-item.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .note-title { font-weight: bold; margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .note-preview { color: var(--text-secondary); font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .editor { flex: 1; display: flex; flex-direction: column; padding: 2rem; }
        .editor-input { border: none; background: transparent; color: var(--text); font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; padding: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .editor-textarea { flex: 1; border: none; background: transparent; color: var(--text); font-size: 1rem; line-height: 1.6; resize: none; font-family: inherit; padding: 0.5rem; }
        .editor-input:focus, .editor-textarea:focus { outline: none; border-color: var(--primary); }
        .delete-btn { background: #ef4444; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .search-input { width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: none; border-radius: 5px; background: rgba(255,255,255,0.05); color: var(--text); }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); flex: 1; display: flex; flex-direction: column; justify-content: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <button class="new-note-btn" onclick="createNewNote()">
                <i class="fas fa-plus"></i> Новая заметка
            </button>
            <input type="text" class="search-input" placeholder="Поиск..." onkeyup="searchNotes(this.value)">
            <div class="notes-list" id="notesList"></div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1><i class="fas fa-sticky-note"></i> Neuron Notes</h1>
                <div id="editorActions" style="display: none;">
                    <button class="delete-btn" onclick="deleteCurrentNote()">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                </div>
            </div>

            <div class="editor" id="editor" style="display: none;">
                <input type="text" class="editor-input" id="noteTitle" placeholder="Заголовок" oninput="saveNote()">
                <textarea class="editor-textarea" id="noteContent" placeholder="Начните писать..." oninput="saveNote()"></textarea>
            </div>

            <div class="empty-state" id="emptyState">
                <i class="fas fa-sticky-note" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                <h3>Выберите заметку или создайте новую</h3>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация Firebase (та же, что в Study)
        const firebaseConfig = { 
            apiKey: "AIzaSyDOaDVzzPjyYm4HWMND2XYWjLy_h4wty5s", 
            authDomain: "neuron-ecosystem-2025.firebaseapp.com", 
            projectId: "neuron-ecosystem-2025", 
            storageBucket: "neuron-ecosystem-2025.firebasestorage.app", 
            messagingSenderId: "589834476565", 
            appId: "1:589834476565:web:c9c878a905ecece4dd421c" 
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentNotes = [];
        let currentNoteId = null;
        let saveTimeout = null;

        // Отслеживание авторизации
        auth.onAuthStateChanged(user => {
            if (user) {
                loadFirebaseNotes(user.uid);
            } else {
                // Если не вошел, запускаем вход (как в Study)
                auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
            }
        });

        // Загрузка заметок из Firebase
        function loadFirebaseNotes(uid) {
            db.collection('users').doc(uid).collection('notes')
                .orderBy('updated', 'desc')
                .onSnapshot(snapshot => {
                    currentNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderNotes();
                });
        }

        function createNewNote() {
            if (!auth.currentUser) return;
            
            const newNoteId = Date.now().toString();
            const newNote = {
                title: 'Новая заметка',
                content: '',
                timestamp: new Date().toLocaleString(),
                updated: Date.now(),
                type: 'note' // Метка для ИИ
            };

            db.collection('users').doc(auth.currentUser.uid)
              .collection('notes').doc(newNoteId).set(newNote);
            
            openNote(newNoteId);
        }

        function renderNotes(filtered = null) {
            const list = document.getElementById('notesList');
            list.innerHTML = '';
            const data = filtered || currentNotes;

            data.forEach(note => {
                const item = document.createElement('div');
                item.className = `note-item ${note.id === currentNoteId ? 'active' : ''}`;
                item.onclick = () => openNote(note.id);
                item.innerHTML = `
                    <div class="note-title">${note.title || 'Без названия'}</div>
                    <div class="note-preview">${note.content.substring(0, 50) || 'Текст...'}</div>
                    <div style="font-size:0.7rem; color:var(--text-secondary); margin-top:5px;">${note.timestamp}</div>
                `;
                list.appendChild(item);
            });
        }

        function openNote(id) {
            currentNoteId = id;
            const note = currentNotes.find(n => n.id === id);
            if (!note) return;

            document.getElementById('editor').style.display = 'flex';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('editorActions').style.display = 'block';
            
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            
            renderNotes();
        }

        function saveNote() {
            if (!currentNoteId || !auth.currentUser) return;

            clearTimeout(saveTimeout);
            // Задержка сохранения (debounce), чтобы не спамить в БД при каждом символе
            saveTimeout = setTimeout(() => {
                const title = document.getElementById('noteTitle').value;
                const content = document.getElementById('noteContent').value;

                db.collection('users').doc(auth.currentUser.uid)
                  .collection('notes').doc(currentNoteId).update({
                    title: title,
                    content: content,
                    updated: Date.now(),
                    timestamp: new Date().toLocaleString()
                });
            }, 800);
        }

        function deleteCurrentNote() {
            if (!currentNoteId || !confirm('Удалить заметку?')) return;

            db.collection('users').doc(auth.currentUser.uid)
              .collection('notes').doc(currentNoteId).delete();
            
            document.getElementById('editor').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('editorActions').style.display = 'none';
            currentNoteId = null;
        }

        function searchNotes(query) {
            const filtered = currentNotes.filter(n => 
                n.title.toLowerCase().includes(query.toLowerCase()) || 
                n.content.toLowerCase().includes(query.toLowerCase())
            );
            renderNotes(filtered);
        }
    </script>
</body>
</html>
