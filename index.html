<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuron Notes - Облачные заметки</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #6366f1; --bg: #0f0f23; --card-bg: #1a1b2e; --text: #ffffff; --text-secondary: #a0a0c0; --success: #22c55e; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        .container { display: flex; height: 100%; max-width: 1400px; margin: 0 auto; }
        .sidebar { width: 300px; background: var(--card-bg); padding: 1rem; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .header { padding: 1rem 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-save { background: var(--success); color: white; margin-right: 10px; }
        .notes-list { flex: 1; overflow-y: auto; margin-top: 15px; }
        .note-item { background: rgba(255,255,255,0.03); padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer; border: 1px solid transparent; }
        .note-item.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .editor { flex: 1; display: flex; flex-direction: column; padding: 2rem; }
        .editor-input { border: none; background: transparent; color: var(--text); font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; outline: none; }
        .editor-textarea { flex: 1; border: none; background: transparent; color: var(--text); font-size: 1.1rem; resize: none; outline: none; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <button class="btn btn-primary" id="addBtn" style="display:none;" onclick="createNewNote()">+ Новая заметка</button>
            <div class="notes-list" id="notesList"></div>
        </div>
        <div class="main-content">
            <header class="header">
                <div style="font-weight:bold;">Neuron <span style="color:var(--primary)">Notes</span></div>
                <div>
                    <button id="loginBtn" class="btn btn-primary" onclick="login()">Войти</button>
                    <button id="logoutBtn" class="btn btn-primary" style="display:none; background:#ef4444;" onclick="logout()">Выйти</button>
                </div>
            </header>
            <div id="editorUI" class="editor" style="display: none;">
                <div style="text-align: right; margin-bottom: 15px;">
                    <button class="btn btn-save" onclick="manualSave()"><i class="fas fa-save"></i> Сохранить для ИИ</button>
                    <button class="btn" style="background:#ef4444; color:white;" onclick="deleteNote()"><i class="fas fa-trash"></i></button>
                </div>
                <input type="text" id="noteTitle" class="editor-input" placeholder="Заголовок">
                <textarea id="noteContent" class="editor-textarea" placeholder="Ваш текст здесь..."></textarea>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyDOaDVzzPjyYm4HWMND2XYWjLy_h4wty5s", 
            authDomain: "neuron-ecosystem-2025.firebaseapp.com", 
            projectId: "neuron-ecosystem-2025", 
            storageBucket: "neuron-ecosystem-2025.firebasestorage.app", 
            messagingSenderId: "589834476565", 
            appId: "1:589834476565:web:c9c878a905ecece4dd421c" 
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentNotes = [];
        let currentNoteId = null;

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout() { auth.signOut().then(() => location.reload()); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('addBtn').style.display = 'block';
                loadNotes(user.uid);
            }
        });

        function loadNotes(uid) {
            db.collection('users').doc(uid).collection('notes').orderBy('updated', 'desc').onSnapshot(snap => {
                currentNotes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotes();
            });
        }

        function createNewNote() {
            const id = Date.now().toString();
            const note = { title: 'Новая заметка', content: '', updated: Date.now() };
            db.collection('users').doc(auth.currentUser.uid).collection('notes').doc(id).set(note);
            openNote(id);
        }

        function openNote(id) {
            currentNoteId = id;
            const note = currentNotes.find(n => n.id === id);
            if (!note) return;
            document.getElementById('editorUI').style.display = 'flex';
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            renderNotes();
        }

        // САМАЯ ВАЖНАЯ ФУНКЦИЯ ДЛЯ ИИ
        async function manualSave() {
            if (!currentNoteId || !auth.currentUser) return;
            
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            const uid = auth.currentUser.uid;

            // 1. Сохраняем саму заметку
            await db.collection('users').doc(uid).collection('notes').doc(currentNoteId).update({
                title: title,
                content: content,
                updated: Date.now()
            });

            // 2. Генерируем "all_notes" для ИИ
            // Проходим по всем заметкам, обновляя текущую в памяти перед склейкой
            const fullText = currentNotes.map(n => {
                const t = n.id === currentNoteId ? title : n.title;
                const c = n.id === currentNoteId ? content : n.content;
                return `--- ${t} ---\n${c}`;
            }).join('\n\n');

            // 3. Записываем в основной документ пользователя, который читает ИИ
            await db.collection('users').doc(uid).set({
                all_notes: fullText,
                last_updated: Date.now()
            }, { merge: true });

            alert("Сохранено! Теперь ИИ увидит изменения.");
        }

        function renderNotes() {
            const list = document.getElementById('notesList');
            list.innerHTML = '';
            currentNotes.forEach(n => {
                const div = document.createElement('div');
                div.className = `note-item ${n.id === currentNoteId ? 'active' : ''}`;
                div.onclick = () => openNote(n.id);
                div.innerHTML = `<strong>${n.title || 'Без названия'}</strong>`;
                list.appendChild(div);
            });
        }

        function deleteNote() {
            if (confirm("Удалить заметку?")) {
                db.collection('users').doc(auth.currentUser.uid).collection('notes').doc(currentNoteId).delete();
                document.getElementById('editorUI').style.display = 'none';
            }
        }
    </script>
</body>
</html>
